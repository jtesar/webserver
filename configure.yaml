- name: "Add installed hosts"
  hosts: "localhost"
  gather_facts: false
  tasks:
    - add_host:
         name: "{{ item }}"
         group: "hosts_to_configure"
      loop: "{{ successfull_hosts | default([]) }}"

    - fail:
      when: "successfull_hosts|length == 0"


- name: "Configure the apache webserver"
  hosts: "hosts_to_configure"
  user: "devops"
  become: true
  become_user: "root"
  become_method: "sudo"
  vars_files:
    - "config.yaml"
  tasks:
  - block:
    - name: "Deploy configuration file"
      ansible.builtin.template:
        src: "httpd.conf.j2"
        dest: "/etc/httpd/conf/httpd.conf"

    - name: "Put webserver content in place"
      ansible.builtin.copy:
        src: "content/{{ inventory_hostname }}/"
        dest: "/var/www/html/"


    - name: "Start the service"
      ansible.builtin.service:
        name: "httpd"
        enabled: true
        state: "started"

    - name: "Set success state"
      ansible.builtin.file:
        path: "/var/run/web_install_success"
        state: "touch"

    always:
    - name: "Get configuration result"
      set_stats:
        aggregate: false
        data:
          failed_hosts: "{{ ansible_play_hosts_all | difference(ansible_play_hosts) }}"
          successfull_hosts: "{{ ansible_play_hosts }}"
          message: "Configuration result"
      run_once: true
      delegate_to: "localhost"
        

  handlers:
    - name: "restart_httpd"
      ansible.builtin.service:
        name: "httpd"
        state: "restarted"
