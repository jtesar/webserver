- name: "Install and configure webserver"
  hosts:
    - web1
    - web2
    - web3
    - web4
--
  user: devops
  become: true
  vars_files:
    - "config.yaml"
--
  tasks:
--
    - name: "Make sure appache is installed"
      package:
        name: "httpd"
        state: "present"
--

    - name: "Deploy configuration file"
      template:
        src: httpd.conf.j2
        dest: /etc/httpd/conf/httpd.conf
--

    - name: "Put webserver content in place"
      copy:
        src: "content/{{ inventory_hostname }}/"
        dest: "/var/www/html/"
--

    - name: "Open firewall"
      ansible.posix.firewalld:
        port: "{{ config[inventory_hostname].port }}/tcp"
        state: "enabled"
      when: "config[inventory_hostname].port is defined"
--


    - name: "Open firewall"
      ansible.posix.firewalld:
        port: "80/tcp"
        state: "enabled"
      when: "config[inventory_hostname].port is not defined"
--

    - name: "Start the service"
      service:
        name: "httpd"
        enabled: true
        state: "started"
--

  handlers:
--
    - name: "restart_httpd"
      service:
        name: "httpd"
        state: "restarted"
--
----
